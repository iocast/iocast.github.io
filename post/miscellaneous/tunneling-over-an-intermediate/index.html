<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="blog, cheatsheets, best practices, and more">
  <meta name="author" content="Iocast">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

  <title>Tunneling over an intermediate to overcome demilitarized zone -- think twice code once!</title>


  


  
  <link rel="stylesheet" type="text/css" href="http://iocast.github.iosemantic/semantic.min.css">


  <style type="text/css">
    .hidden.menu {
      display: none;
    }
    .masthead.segment {
      min-height: 700px;
      padding: 1em 0em;
    }
    .masthead .logo.item img {
      margin-right: 1em;
    }
    .masthead .ui.menu .ui.button {
      margin-left: 0.5em;
    }
    .masthead h1.ui.header {
      margin-top: 3em;
      margin-bottom: 0em;
      font-size: 4em;
      font-weight: normal;
    }
    .masthead h2 {
      font-size: 1.7em;
      font-weight: normal;
    }
    .ui.vertical.stripe {
      padding: 8em 0em;
    }
    .ui.vertical.stripe h3 {
      font-size: 2em;
    }
    .ui.vertical.stripe .button + h3,
    .ui.vertical.stripe p + h3 {
      margin-top: 3em;
    }
    .ui.vertical.stripe .floated.image {
      clear: both;
    }
    .ui.vertical.stripe p {
      font-size: 1.33em;
    }
    .ui.vertical.stripe .horizontal.divider {
      margin: 3em 0em;
    }
    .quote.stripe.segment {
      padding: 0em;
    }
    .quote.stripe.segment .grid .column {
      padding-top: 5em;
      padding-bottom: 5em;
    }
    .footer.segment {
      padding: 5em 0em;
    }
    .secondary.pointing.menu .toc.item {
      display: none;
    }
    @media only screen and (max-width: 700px) {
      .ui.fixed.menu {
        display: none !important;
      }
      .secondary.pointing.menu .item,
      .secondary.pointing.menu .menu {
        display: none;
      }
      .secondary.pointing.menu .toc.item {
        display: block;
      }
      .masthead.segment {
        min-height: 350px;
      }
      .masthead h1.ui.header {
        font-size: 2em;
        margin-top: 1.5em;
      }
      .masthead h2 {
        margin-top: 0.5em;
        font-size: 1.5em;
      }
    }
  </style>


  <script src="http://iocast.github.iojquery-3.3.1.min.js"></script>
  <script src="http://iocast.github.iosemantic/semantic.min.js"></script>
  <script src="http://iocast.github.iomasonry.pkgd.min.js"></script>


  <script>
    $(document)
      .ready(function () {
        
        $('.masthead')
          .visibility({
            once: false,
            onBottomPassed: function () {
              $('.fixed.menu').transition('fade in');
            },
            onBottomPassedReverse: function () {
              $('.fixed.menu').transition('fade out');
            }
          })
          ;
        
        $('.ui.sidebar')
          .sidebar('attach events', '.toc.item')
          ;
      });
  </script>


  <link rel="stylesheet" type="text/css" href="http://iocast.github.iocss/syntax.css">
  <link rel="stylesheet" type="text/css" href="http://iocast.github.iocss/main.css">

</head>
<body>

  
  <div class="ui large top fixed hidden menu">
    <div class="ui container">
      
      <a class=" item" href="http://iocast.github.io/">Home</a>
      
      <a class="active item" href="http://iocast.github.io/post/">Archives</a>
      
      <a class=" item" href="http://iocast.github.io/cheatsheet/">Cheatsheets</a>
      
      
    </div>
  </div>

  
  <div class="ui vertical inverted sidebar menu">
    
    <a class=" item" href="http://iocast.github.io/">Home</a>
    
    <a class="active item" href="http://iocast.github.io/post/">Archives</a>
    
    <a class=" item" href="http://iocast.github.io/cheatsheet/">Cheatsheets</a>
    
    
  </div>

  
  <div class="pusher">
    <div class="ui inverted vertical masthead center aligned segment">

      <div class="ui container">
        <div class="ui large secondary inverted pointing menu">
          <a class="toc item">
            <i class="sidebar icon"></i>
          </a>
          
          <a class=" item" href="http://iocast.github.io/">Home</a>
          
          <a class="active item" href="http://iocast.github.io/post/">Archives</a>
          
          <a class=" item" href="http://iocast.github.io/cheatsheet/">Cheatsheets</a>
          
          
        </div>
      </div>

      <div class="ui text container">
        <h1 class="ui inverted header">
          TUNNELING OVER AN INTERMEDIATE TO OVERCOME DEMILITARIZED ZONE
        </h1>
        <h2>Often you want to connect to a computer inside a network that is hidden from the outside. This &#34;private&#34; network, aka demilitarized zone (DMZ), can be overcome by having a computer inside the DMZ that opens a connection to an other &#34;open&#34; network or computer. This article describes roughly how to do that using Linux.</h2>
      </div>

    </div>


    <div class="ui vertical stripe segment">
      <div class="ui middle aligned stackable grid container">
        <div class="row">
          <div class="sixteen  wide column">
            

<div class="main ui container sticky--container" style="position: relative; margin-right: 387px !important; width: auto !important; max-width: 960px !important;">

  <div class="ui dividing right rail" style="margin-left: 3em; padding-top: 2em; width: 319px;">
    <div class="ui sticky">
      <h4 class="ui header">Tunneling over an intermediate to overcome demilitarized zone</h4>
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#client">Client</a>
<ul>
<li><a href="#opening-a-tunnel-from-client-to-intermediary">Opening a tunnel from client to intermediary</a></li>
<li><a href="#connecting-to-server">Connecting to server</a></li>
<li><a href="#copy-files-scp">Copy files (SCP)</a></li>
</ul></li>
<li><a href="#intermediary">Intermediary</a>
<ul>
<li><a href="#register-gpg-key-from-server">Register GPG key from server</a></li>
</ul></li>
<li><a href="#server">Server</a>
<ul>
<li><a href="#export-gpg-key">Export GPG key</a></li>
<li><a href="#open-a-connection-to-intermediary-from-server">Open a connection to intermediary from server</a></li>
<li><a href="#register-cron-job">Register cron job</a></li>
</ul></li>
</ul></li>
</ul>
</nav>

    </div>
  </div>

  <div>
    

<p>Source code: <a href="resources/code/shell/tunneling.sh">shell script</a></p>

<p>Tunneling over a intermediar is often used to connect to a server which is e.g. in a DMZ. In the following case we have a server that is the company network and does only allow connections on port 22 from the DMZ. Means the server cannot be connection over the internet. In addition, we have a server in the DMZ which allows connection on port 22 from outside (internet) and can connect to the company network over port 22. Last but not least, every time a server restarts we want that the tunnels automatically opens, means that we need to have an <code>cron</code> job that checks, whether an open connection exists from the server to the intermediary or not, and if the server opens a connection to the intermediary the system does not need to prompt for password. Solution is here to register the public key of the server on the intermediary.</p>

<h2 class="ui header" id="client">Client</h2>

<h3 class="ui header" id="opening-a-tunnel-from-client-to-intermediary">Opening a tunnel from client to intermediary</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ssh -L <span class="m">22000</span>:127.0.0.1:22000 -N root@152.96.56.32</code></pre></div>
<h3 class="ui header" id="connecting-to-server">Connecting to server</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ssh -P <span class="m">22000</span> michel@127.0.0.1</code></pre></div>
<h3 class="ui header" id="copy-files-scp">Copy files (SCP)</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#get</span>
scp -P <span class="m">22000</span> michel@127.0.0.1:/home/michel/tunelling.sh /Users/michel/Public/Drop<span class="se">\ </span>Box/

<span class="c1">#put</span>
scp /Users/michel/Public/Drop<span class="se">\ </span>Box/tunelling.sh -P <span class="m">22000</span> michel@127.0.0.1:/home/michel/</code></pre></div>
<h2 class="ui header" id="intermediary">Intermediary</h2>

<h3 class="ui header" id="register-gpg-key-from-server">Register GPG key from server</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">apt-key add &lt;file&gt;</code></pre></div>
<h2 class="ui header" id="server">Server</h2>

<h3 class="ui header" id="export-gpg-key">Export GPG key</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">apt-key <span class="nb">export</span> &lt;key&gt; &gt; &lt;file&gt;</code></pre></div>
<h3 class="ui header" id="open-a-connection-to-intermediary-from-server">Open a connection to intermediary from server</h3>

<p>Save the following script as e.g. tunneling.sh</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span>
<span class="nv">cmd</span><span class="o">=</span><span class="s2">&#34;ssh -R 22000:127.0.0.1:22 -N root@152.96.56.32&#34;</span>

<span class="nv">match</span><span class="o">=</span><span class="k">$(</span>ps -aef <span class="p">|</span> grep <span class="s2">&#34;</span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">|</span> grep -v grep<span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="si">${</span><span class="nv">match</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
<span class="nv">$cmd</span> <span class="p">&amp;</span>
<span class="k">fi</span></code></pre></div>
<h3 class="ui header" id="register-cron-job">Register cron job</h3>

<p>Edit crontab</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">crontab -e</code></pre></div>
<p>Adding a new job to the crontab. The following entry executes the defined script <code>tunneling.sh</code> every 5 minutes.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="m">5</span> * * * * /&lt;path&gt;/tunnelilng.sh</code></pre></div>
<p>Crontab is structured as follow:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">* * * * * <span class="nb">command</span> to be executed
- - - - -
<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> ----- Day of week <span class="o">(</span><span class="m">0</span> - <span class="m">7</span><span class="o">)</span> <span class="o">(</span><span class="nv">Sunday</span><span class="o">=</span><span class="m">0</span> or <span class="m">7</span><span class="o">)</span>
<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> ------- Month <span class="o">(</span><span class="m">1</span> - <span class="m">12</span><span class="o">)</span>
<span class="p">|</span> <span class="p">|</span> --------- Day of month <span class="o">(</span><span class="m">1</span> - <span class="m">31</span><span class="o">)</span>
<span class="p">|</span> ----------- Hour <span class="o">(</span><span class="m">0</span> - <span class="m">23</span><span class="o">)</span>
------------- Minute <span class="o">(</span><span class="m">0</span> - <span class="m">59</span><span class="o">)</span></code></pre></div>
  </div>

</div>

<script>
  $('.ui.sticky').sticky({
    context: '.sticky--container',
    offset: 56
  });
</script>


          </div>
        </div>
      </div>
    </div>

  </div>

  </body>

</html>
