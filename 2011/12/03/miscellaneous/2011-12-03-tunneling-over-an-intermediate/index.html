<!doctype html>
<html lang="en-US">
	<head>
			<meta charset="utf-8" />
	
  <title>Tunneling over an intermediate to overcome demilitarized zone | iocast&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


	
		<link rel="icon" href="/favicon.png">
	


	<script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/jquery.mixitup.min.js" type="text/javascript"></script>
<script src="/js/stickyfill.js" type="text/javascript"></script>

	<!--CDN links for the latest TweenLite, CSSPlugin, and EasePack-->
	<script src="http://www.greensock.com/js/src/utils/SplitText.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/CSSPlugin.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/easing/EasePack.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TimelineLite.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenLite.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.4/hammer.min.js"></script>


	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>

	<link rel="stylesheet" href="/css/font-awesome.min.css" type="text/css">


	
		<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
		<script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
		
		<link rel="stylesheet" href="/css/post.css" type="text/css">
		<script src="/js/post.js" type="text/javascript"></script>
	

	<link rel="stylesheet" href="/css/style.css" type="text/css">

	</head>
	<body>
		
<div class="wrapper cf">
	<div class="content article-entry">
		<header>
			<h1>Tunneling over an intermediate to overcome demilitarized zone</h1>
		</header>
		<small>
			
				<a href="http://localhost:4000/categories/Miscellaneous/" rel="tag tooltip" class="label light" data-placement="right" data-original-title="2 articles in this category"><i class="fa fa-dot-circle-o"></i> Miscellaneous</a>
			
      <a href="http://localhost:4000/2011/12/03/miscellaneous/2011-12-03-tunneling-over-an-intermediate/#disqus_thread" class="scrollTo label label-default light" data-disqus-identifier="blog/2014/07/21-javascript-internationalization-part1.html"><i class="fa fa-comment-o"></i> ?? Comments</a>
      <span class="label label-default light">21/Jul/2014 Mon</span>
    </small>

		<p>Source code: <a href="resources/code/shell/tunneling.sh">shell script</a></p>
<p>Tunneling over a intermediar is often used to connect to a server which is e.g. in a DMZ. In the following case we have a server that is the company network and does only allow connections on port 22 from the DMZ. Means the server cannot be connection over the internet. In addition, we have a server in the DMZ which allows connection on port 22 from outside (internet) and can connect to the company network over port 22. Last but not least, every time a server restarts we want that the tunnels automatically opens, means that we need to have an <code>cron</code> job that checks, whether an open connection exists from the server to the intermediary or not, and if the server opens a connection to the intermediary the system does not need to prompt for password. Solution is here to register the public key of the server on the intermediary.</p>
<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><h3 id="Opening_a_tunnel_from_client_to_intermediary"><a href="#Opening_a_tunnel_from_client_to_intermediary" class="headerlink" title="Opening a tunnel from client to intermediary"></a>Opening a tunnel from client to intermediary</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -L <span class="number">22000</span>:<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">22000</span> -N root@<span class="number">152.96</span>.<span class="number">56.32</span></span><br></pre></td></tr></table></figure>
<h3 id="Connecting_to_server"><a href="#Connecting_to_server" class="headerlink" title="Connecting to server"></a>Connecting to server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -P <span class="number">22000</span> michel@<span class="number">127.0</span>.<span class="number">0.1</span></span><br></pre></td></tr></table></figure>
<h3 id="Copy_files__28SCP_29"><a href="#Copy_files__28SCP_29" class="headerlink" title="Copy files (SCP)"></a>Copy files (SCP)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#get</span></span><br><span class="line">scp -P <span class="number">22000</span> michel@<span class="number">127.0</span>.<span class="number">0.1</span>:/home/michel/tunelling.sh /Users/michel/Public/Drop\ Box/</span><br><span class="line"></span><br><span class="line"><span class="comment">#put</span></span><br><span class="line">scp /Users/michel/Public/Drop\ Box/tunelling.sh -P <span class="number">22000</span> michel@<span class="number">127.0</span>.<span class="number">0.1</span>:/home/michel/</span><br></pre></td></tr></table></figure>
<h2 id="Intermediary"><a href="#Intermediary" class="headerlink" title="Intermediary"></a>Intermediary</h2><h3 id="Register_GPG_key_from_server"><a href="#Register_GPG_key_from_server" class="headerlink" title="Register GPG key from server"></a>Register GPG key from server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt-key add &lt;file&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><h3 id="Export_GPG_key"><a href="#Export_GPG_key" class="headerlink" title="Export GPG key"></a>Export GPG key</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt-key <span class="built_in">export</span> &lt;key&gt; &gt; &lt;file&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Open_a_connection_to_intermediary_from_server"><a href="#Open_a_connection_to_intermediary_from_server" class="headerlink" title="Open a connection to intermediary from server"></a>Open a connection to intermediary from server</h3><p>Save the following script as e.g. tunneling.sh</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">cmd=<span class="string">"ssh -R 22000:127.0.0.1:22 -N root@152.96.56.32"</span></span><br><span class="line"></span><br><span class="line">match=$(ps -aef | grep <span class="string">"<span class="variable">$&#123;cmd&#125;</span>"</span> | grep -v grep)</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$&#123;match&#125;</span>"</span> ] ; <span class="keyword">then</span></span><br><span class="line"><span class="variable">$cmd</span> &amp;</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<h3 id="Register_cron_job"><a href="#Register_cron_job" class="headerlink" title="Register cron job"></a>Register cron job</h3><p>Edit crontab</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">crontab <span class="operator">-e</span></span><br></pre></td></tr></table></figure>
<p>Adding a new job to the crontab. The following entry executes the defined script <code>tunneling.sh</code> every 5 minutes.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="number">5</span> * * * * /&lt;path&gt;/tunnelilng.sh</span><br></pre></td></tr></table></figure>
<p>Crontab is structured as follow:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">* * * * * <span class="built_in">command</span> to be executed</span><br><span class="line">- - - - -</span><br><span class="line">| | | | |</span><br><span class="line">| | | | ----- Day of week (<span class="number">0</span> - <span class="number">7</span>) (Sunday=<span class="number">0</span> or <span class="number">7</span>)</span><br><span class="line">| | | ------- Month (<span class="number">1</span> - <span class="number">12</span>)</span><br><span class="line">| | --------- Day of month (<span class="number">1</span> - <span class="number">31</span>)</span><br><span class="line">| ----------- Hour (<span class="number">0</span> - <span class="number">23</span>)</span><br><span class="line">------------- Minute (<span class="number">0</span> - <span class="number">59</span>)</span><br></pre></td></tr></table></figure>

	</div>
	<div id="sidebar" class="sidebar">
		<h3>Table of Content</h3>
		<nav class="toc">
			<ol class="toc-item"><li class="toc-item-item toc-item-level-2"><a class="toc-item-link" href="#Client"><span class="toc-item-text">Client</span></a><ol class="toc-item-child"><li class="toc-item-item toc-item-level-3"><a class="toc-item-link" href="#Opening_a_tunnel_from_client_to_intermediary"><span class="toc-item-text">Opening a tunnel from client to intermediary</span></a></li><li class="toc-item-item toc-item-level-3"><a class="toc-item-link" href="#Connecting_to_server"><span class="toc-item-text">Connecting to server</span></a></li><li class="toc-item-item toc-item-level-3"><a class="toc-item-link" href="#Copy_files__28SCP_29"><span class="toc-item-text">Copy files (SCP)</span></a></li></ol></li><li class="toc-item-item toc-item-level-2"><a class="toc-item-link" href="#Intermediary"><span class="toc-item-text">Intermediary</span></a><ol class="toc-item-child"><li class="toc-item-item toc-item-level-3"><a class="toc-item-link" href="#Register_GPG_key_from_server"><span class="toc-item-text">Register GPG key from server</span></a></li></ol></li><li class="toc-item-item toc-item-level-2"><a class="toc-item-link" href="#Server"><span class="toc-item-text">Server</span></a><ol class="toc-item-child"><li class="toc-item-item toc-item-level-3"><a class="toc-item-link" href="#Export_GPG_key"><span class="toc-item-text">Export GPG key</span></a></li><li class="toc-item-item toc-item-level-3"><a class="toc-item-link" href="#Open_a_connection_to_intermediary_from_server"><span class="toc-item-text">Open a connection to intermediary from server</span></a></li><li class="toc-item-item toc-item-level-3"><a class="toc-item-link" href="#Register_cron_job"><span class="toc-item-text">Register cron job</span></a></li></ol></li></ol>
		</nav>
	</div>
</div>

	</body>
</html>
